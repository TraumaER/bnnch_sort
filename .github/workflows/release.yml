name: Release

on:
  push:
    tags:
      - 'v*+mc*'

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Set up Java 21
        uses: actions/setup-java@be666c2fcd27ec809703dec50e508c2fdc7f6654 # v5.2.0
        with:
          distribution: temurin
          java-version: 21

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@f29f5a9d7b09a7c6b29859002d29d24e1674c884 # v5.0.1

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Extract version info from tag
        id: version
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          echo "tag=$TAG" >> $GITHUB_OUTPUT

          # Extract mod version (e.g., v1.2.3+mc1.21.1 -> 1.2.3)
          MOD_VERSION=$(echo "$TAG" | sed 's/^v//' | sed 's/+mc.*//')
          echo "mod_version=$MOD_VERSION" >> $GITHUB_OUTPUT

          # Extract MC version (e.g., v1.2.3+mc1.21.1 -> 1.21.1)
          MC_VERSION=$(echo "$TAG" | sed 's/.*+mc//')
          echo "mc_version=$MC_VERSION" >> $GITHUB_OUTPUT

          echo "Extracted: mod_version=$MOD_VERSION, mc_version=$MC_VERSION"

      - name: Build
        run: ./gradlew build

      - name: Find JAR file
        id: find_jar
        run: |
          JAR_PATH=$(find build/libs -name "*.jar" ! -name "*-sources.jar" | head -1)
          JAR_NAME=$(basename "$JAR_PATH")
          echo "jar_path=$JAR_PATH" >> $GITHUB_OUTPUT
          echo "jar_name=$JAR_NAME" >> $GITHUB_OUTPUT
          echo "Found JAR: $JAR_PATH"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@da05d552573ad5aba039eaac05058a918a7bf631 # v2.2.2
        with:
          name: ${{ steps.version.outputs.tag }}
          body: |
            ## Bnnch: Sort ${{ steps.version.outputs.mod_version }}

            **Minecraft Version:** ${{ steps.version.outputs.mc_version }}

            ### Installation
            1. Download the JAR file below
            2. Place it in your `mods` folder
            3. Requires NeoForge for Minecraft ${{ steps.version.outputs.mc_version }}

            ---
            *Full changelog and source code available in this repository.*
          files: ${{ steps.find_jar.outputs.jar_path }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
